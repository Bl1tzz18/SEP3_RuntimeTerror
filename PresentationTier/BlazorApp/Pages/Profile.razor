@page "/Profile"
@using System.Security.Claims
@using BlazorApp.Services
@using global::Shared.DTOs
@using global::Shared.Models
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavManager
@inject IAuthService AuthService


<AuthorizeView>
    <Authorized>

<section>
<div class="row">
  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-body text-center">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="avatar"
             class="rounded-circle img-fluid" style="width: 150px;">
        <h5 class="my-3">@GetClaimValue(AuthState.Result.User, "FirstName") @GetClaimValue(AuthState.Result.User, "LastName")</h5>
        <p class="text-muted mb-4">Credits: @GetClaimValue(AuthState.Result.User, "Credits")</p>
        <div class="d-flex justify-content-center mb-2">
          <button type="button" class="btn btn-primary" @onclick="onDisable">Edit Profile</button>
        </div>
      </div>
    </div>
  </div>


  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-body">

        <div class="row">
          <div class="col-sm-3">
            <p class="mb-0">First Name</p>
          </div>
          <div class="col-sm-9">
            <input class="mb-0" disabled="@isDisable" @bind="FirstName">
          </div>
        </div>

        <hr>
        <div class="row">
          <div class="col-sm-3">
            <p class="mb-0">Last Name</p>
          </div>
          <div class="col-sm-9">
            <input class="mb-0" @bind="LastName" disabled="@isDisable">
          </div>
        </div>

        <hr>
        <div class="row">
          <div class="col-sm-3">
            <p class="mb-0">Phone Number</p>
          </div>
          <div class="col-sm-9">
            <input class="mb-0" @bind="phoneNumber" disabled="@isDisable">
          </div>
        </div>

        <hr>
        <div class="row">
          <div class="col-sm-3">
            <p class="mb-0">Country</p>
          </div>
          <div class="col-sm-9">
            <input class="mb-0" @bind="country" disabled="@isDisable">
          </div>
        </div>
              
        <hr>
        <div class="row">
          <div class="col-sm-3">
            <p class="mb-0"> City</p>
          </div>
          <div class="col-sm-9">
            <input class="mb-0" @bind="city" disabled="@isDisable">
          </div>
        </div>

        <hr>
        <div class="row">
          <div class="col-sm-3">
            <p class="mb-0"> Address</p>
          </div>
          <div class="col-sm-9">
            <input class="mb-0" @bind="street" disabled="@isDisable">
          </div>
        </div>

        <hr>
        <div class="row">
          <div class="col-sm-3">
            <p class="mb-0"> Zip-Code</p>
          </div>
          <div class="col-sm-9">
            <input class="mb-0" @bind="zip" disabled="@isDisable">
          </div>
        </div>
        
        <hr>
        <button type="button" class="btn btn-primary" disabled="@isDisable" @onclick="click">Save Changes</button>
      </div>
    </div>
  </div>
</div>
</section>
    </Authorized>
    <NotAuthorized>
        
    </NotAuthorized>
</AuthorizeView>

@code
{
  private bool isDisable { get; set; } = true;
  private string? name;
  private IEnumerable<Claim>? userClaims;

  private String FirstName;
  private String LastName;
  private String phoneNumber;

  private String country;
  private String city;
  private String zip;
  private String street;
  
    [CascadingParameter]
    public Task<AuthenticationState> AuthState { get; set; } = null!;
  
  protected override async Task OnInitializedAsync()
  {
    FirstName = GetClaimValue(AuthState.Result.User, "FirstName");
    LastName = GetClaimValue(AuthState.Result.User, "LastName");
    phoneNumber = GetClaimValue(AuthState.Result.User, "PhoneNumber");
    
  }

  private async Task click()
  {
    onEditProfile();
    onEditNuttonClick();
  }
  
  private async Task onEditProfile()
  {
    try
    {
      AuthenticationState authState = await AuthState;
      ClaimsPrincipal user = authState.User;
      userClaims = user.Claims;
      name = user.Identity!.Name!;

      var address = new Address
      {
        Country = country,
        City = city,
        Zip = zip,
        Street = street
      };

      var dto = new UserInfoCreationDTO
      {
        username = name,
        FirstName = FirstName,
        LastName = LastName,
        phone = phoneNumber,
        Address = address
      };

      await AuthService.EditProfileData(dto);
    }
    catch (Exception e)
    {
      Console.WriteLine(e);
      throw;
    }
  }

  //Method for getting current authenticated user
    static string GetClaimValue(ClaimsPrincipal claimsPrincipal, string type)
        => claimsPrincipal.FindFirst(type)?.Value ?? string.Empty;

  //Methods for enabling/disabling <input>
  private void onDisable()
  {
    this.isDisable = false;
  }
  async Task onEditNuttonClick()
  {
    this.isDisable = true;
  }
}